<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title></title>
  <style media="screen">
    *{padding:0;margin:0}
    .grid{
      width:300px;
      height:500px;
      position:relative;
      margin:auto;
      margin-top:100px;
      border:1px solid #000;
    }
    .unit{
      width:20px;
      height:20px;
      position:absolute;
      border-right:1px solid #000;
      border-bottom:1px solid #000;
    }
    .piece{
      background:red;
      position:absolute;
    }
  </style>
  <script>

    // 15*25

    var score = 0;
    var level = 0;
    var speed = 200;
    var grid = [new Array()];
    var piece = [0,0,0,0];
    var s = 0;
    var r = 0;
    px = 6;
    py = 0 ;
    for(var x=0;x<15;x++){
      grid[x]=new Array();
      for(var y=0;y<25;y++){
          grid[x][y]="";
      }
    }


  function updateGrid(){

    // clear the array
    for(var x=0;x<15;x++){
      for(var y=0;y<25;y++){
         if(grid[x][y]=="P"){
            grid[x][y]="";
          }
      }
    }

    collided = false;
    for(var p=0;p<4; p++){
      // if any piece hits another block in the grid
      if(grid[piece[p][0]][piece[p][1]+1]=='X'){
          collided=true;
      }
      if(piece[p][1]+1==25){
          collided=true;
      }
    }
    if(!collided){
      for(var p=0;p<4; p++){
        piece[p][1]+=1;
        grid[piece[p][0]][piece[p][1]]="P";
      }
      py++;
    }else{
        for(var p=0;p<4; p++){
          grid[piece[p][0]][piece[p][1]]="X";
        }
        newPiece();
    }

}

    function renderGrid(){
        removeElementsByClass('unit');
        for(var x=0;x<grid.length;x++){
          for(var y=0;y<grid[x].length;y++){
              if(grid[x][y]=="X" || grid[x][y]=="P"){
                var c = document.createElement("div");
                c.className = "unit";
                c.style.left = (x*20)+"px";
                c.style.top = (y*20)+"px";
                c.style.background = "blue";
                document.getElementsByClassName('grid')[0].append(c);
              }
          }
        }
    }

    // canvas clear!
    function removeElementsByClass(className){
        var elements = document.getElementsByClassName(className);
        while(elements.length > 0){
            elements[0].parentNode.removeChild(elements[0]);
        }
    }

    function rnd(max) {
        return Math.floor(Math.random() * max);
    }

    function newPiece(){
      px = 6;
      py = 0;
      s = rnd(5);
      r = 0;
      switch(s){
        case 0: // cube
          piece[0]=[px,py+1];
          piece[1]=[px+1,py+1];
          piece[2]=[px,py];
          piece[3]=[px+1,py];
          for(var p=0;p<4; p++){
            grid[piece[p][0]][piece[p][1]]="P";
          }
        break;
        case 1:
          piece[1]=[px+1,py];
          piece[2]=[px,py+1];
          piece[3]=[px+1,py+1];
          piece[0]=[px+2,py+1];
          for(var p=0;p<4; p++){
            grid[piece[p][0]][piece[p][1]]="P";
          }
        break;
        case 2: // line
          piece[0]=[px,py];
          piece[1]=[px+1,py];
          piece[2]=[px+2,py];
          piece[3]=[px+3,py];
          for(var p=0;p<4; p++){
            grid[piece[p][0]][piece[p][1]]="P";
          }
        break;
        case 3:
          piece[0]=[px,py+1];
          piece[1]=[px+1,py+1];
          piece[2]=[px+2,py+1];
          piece[3]=[px+1,py];
          for(var p=0;p<4; p++){
            grid[piece[p][0]][piece[p][1]]="P";
          }
        break;
        case 4:
          piece[2]=[px+1,py];
          piece[3]=[px+2,py];
          piece[0]=[px,py+1];
          piece[1]=[px+1,py+1];
          for(var p=0;p<4; p++){
            grid[piece[p][0]][piece[p][1]]="P";
          }
        break;
      }
    }

    function turnPiece(){
      switch (s) {
        case 0:
          // no rotation needed - square!
        break;
        case 2:
          piece[0]=[px+1,py];
          piece[1]=[px+1,py+1];
          piece[2]=[px+1,py+2];
          piece[3]=[px+1,py+3];
        break;
      }
    }

    function mostRight(){
      i = px;
      for(var p=0;p<4; p++){
        if(piece[p][0]>i){
          i=piece[p][0];
        }
      }
      return i;
    }
    function mostLeft(){
      i = 25;
      for(var p=0;p<4; p++){
        if(piece[p][0]<i){
          i=piece[p][0];
        }
      }
      return i;
    }

    function move(dir){
      if(dir=="right" && mostRight()<14){
        collided=false;
        for(var p=0;p<4; p++){
          if(grid[piece[p][0]+1][piece[p][1]]=="X"){
            collided=true;
          }
        }
        if(!collided){
          for(var p=0;p<4; p++){
              grid[piece[p][0]][piece[p][1]]="";
              piece[p][0]+=1;
          }
          px++;
          return 0;
        }

      }
      if(dir=="left" && mostLeft()>0){
        collided=false;
        for(var p=0;p<4; p++){
          if(grid[piece[p][0]-1][piece[p][1]]=="X"){
            collided=true;
          }
        }
        if(!collided){
          for(var p=0;p<4; p++){
            grid[piece[p][0]][piece[p][1]]="";
            piece[p][0]-=1;
          }
          px--;
          return 0;
        }

      }
    }

    function keyPressed(e){
      switch(e.keyCode){
        case 38:turnPiece();break;
        case 40:move('down');break;
        case 37:move('left');break;
        case 39:move('right');break;
        case 32:newPiece();break;
      }
    }

    function setupNewGame(){
      var b = document.createElement("div");
      b.className = "grid";
      b.tabIndex="1";
      document.body.append(b);
      b.addEventListener("keydown", keyPressed ,false);
    	var draw=setInterval(function(){
          updateGrid();
      		renderGrid();
    	}, speed);
    	b.focus();
    }

    function startGame(){
      removeElementsByClass("grid");
      score = 0;
      level = 0;
      grid = [new Array()];
      piece = [0,0,0,0];
      s = 0;
      r = 0;
      px = 6;
      py = 0 ;
      for(var x=0;x<15;x++){
        grid[x]=new Array();
        for(var y=0;y<25;y++){
            grid[x][y]="";
        }
      }
      speed = 200; // document.getElementById("speed");
      setupNewGame();
      newPiece();
    }

  </script>
  </head>
  <body>
    <input type="button" name="" id=start value="Start game" onclick="startGame()">
    <input type="text" name="" id=speed value="200">
  </body>
</html>
